{% extends "base.html" %}
{% block title %}Contract Excel Processor{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="mb-3">Contract Excel Processor (FTP Only)</h4>

      <!-- Action Buttons -->
      <button class="btn btn-primary" id="btnPending">
        Process Pending Excel
      </button>

      <button class="btn btn-danger ms-2" id="btnRetry">
        Retry ALL Failed
      </button>

      <!-- Status Text -->
      <div class="mt-3 text-muted" id="status">Idle</div>

      <!-- Progress Table -->
      <table class="table table-bordered table-sm mt-3">
        <thead>
          <tr>
            <th>File (Exact Excel Name)</th>
            <th>Status</th>
            <th>Inserted</th>
            <th>Failed</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="progressTable">
          <tr>
            <td colspan="5" class="text-center text-muted">
              No data yet
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- CSRF token -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
/* ================================
   CSRF TOKEN
================================ */
const csrfToken = document
  .querySelector('meta[name="csrf-token"]')
  .getAttribute('content');

/* ================================
   POLLING CONTROL
================================ */
let progressTimer = null;

function startPolling() {
  if (!progressTimer) {
    progressTimer = setInterval(loadProgress, 2000);
  }
}

function stopPolling() {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
}

/* ================================
   POST ACTION (START WORKER)
================================ */
function post(url) {
  document.getElementById("status").innerText = "Processing...";

  fetch(url, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken
    }
  })
  .then(r => r.json())
  .then(d => {
    document.getElementById("status").innerText =
      "Status: " + (d.status || "started");
  })
  .catch(() => {
    document.getElementById("status").innerText =
      "Error occurred (check server logs)";
  });
}

/* ================================
   BUTTON HANDLERS
================================ */
document.getElementById("btnPending").onclick = () => {
  startPolling();
  post("/admin/contracts/process-pending");
};

document.getElementById("btnRetry").onclick = () => {
  startPolling();
  post("/admin/contracts/retry-all");
};

/* ================================
   LOAD PROGRESS
================================ */
function loadProgress() {
  fetch("/admin/contracts/progress")
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("progressTable");
      tbody.innerHTML = "";

      const files = Object.keys(data).filter(k => k !== "_system");

      if (files.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted">
              No progress data
            </td>
          </tr>`;
        return;
      }

      // ✅ ALWAYS RENDER FILES FIRST
      files.forEach(file => {
        const d = data[file];
        tbody.innerHTML += `
          <tr>
            <td>${file}</td>
            <td>${d.status}</td>
            <td>${d.inserted}</td>
            <td>${d.failed}</td>
            <td>${d.updated}</td>
          </tr>`;
      });

      // ------------------------------
      // NOW decide whether to stop polling
      // ------------------------------

      // 1️⃣ Stop if backend explicitly says idle
      if (data._system && data._system.status === "idle") {
        document.getElementById("status").innerText =
          "Idle – No pending contract files";
        stopPolling();
        return;
      }

      // 2️⃣ Stop if all files are completed
      const allCompleted =
        files.length > 0 &&
        files.every(f => data[f].status === "completed");

      if (allCompleted) {
        document.getElementById("status").innerText =
          "Idle – All contract files processed";
        stopPolling();
      }
    })
    .catch(() => {
      stopPolling();
    });
}


/* ================================
   IMPORTANT
   ❌ DO NOT AUTO START POLLING
   Polling starts ONLY on button click
================================ */
</script>

{% endblock %}
