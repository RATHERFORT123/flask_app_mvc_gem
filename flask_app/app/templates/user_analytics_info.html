{% extends "base.html" %}
{% block title %}Analytics{% endblock %}

{% block content %}

<style>
/* ---------- CHART FIXES ---------- */
.chart-container {
    position: relative;
    height: 320px;
    width: 100%;
}

.card-body canvas {
    width: 100% !important;
    height: 100% !important;
}
</style>

<div class="container my-4">
    <h2 class="mb-3 fw-bold">Contracts Analytics Dashboard</h2>

    <!-- FILTERS -->
    <div class="box p-3 mb-4 bg-white">
        <form id="analytics-filters" class="row g-3 align-items-end">
<div class="col-md-3">
    <label>Brands</label>
    
    <div class="dropdown">
        <button
            class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
            type="button"
            id="brandDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
        >
            Select Brands
        </button>

        <ul class="dropdown-menu w-100 p-2"
            aria-labelledby="brandDropdown"
            id="brandDropdownMenu"
            style="max-height:200px; overflow-y:auto;">
            <li class="dropdown-item text-muted">Loading brandsâ€¦</li>
        </ul>
    </div>
    <!-- <div class="border rounded p-2" style="max-height:150px; overflow-y:auto" id="brand-box">
        <div class="text-muted">Loading brands...</div>
    </div> -->
</div>
<!-- <div class="col-md-3">
    <label class="form-label">Brands</label>

</div> -->

<!-- <div id="brandToggle">
    <span id="brandToggleText">Select Brands</span>
</div>

<div id="brandDropdown"></div> -->


            <div class="col-md-3">
                <label>Status</label>
                <select class="form-select" name="status">
                    <option value="">All Statuses</option>
                    <option>Fullfillment in Progress</option>
                    <option>Order Completed</option>
                    <option>Order Accepted</option>
                    <option>Order Paid</option>
                    <option>Order Cancelled</option>
                    <option>Waiting for Seller Confirmation</option>
                    <option>Waiting for Seller Payment</option>
                    <option>Cancellation Requested by Buyer</option>
                    <option>Waiting For Payment Confirmation</option>
                    <option>OrderPlaced</option>
                    <option>WaitingForBuyerAction</option>
                </select>
            </div>

            <div class="col-md-2">
                <label>Buying Mode</label>
                <select class="form-select" name="buying_mode">
                    <option value="">All Types</option>
                    <option>Bid/RA</option>
                    <option>Direct</option>
                </select>
            </div>

            <div class="col-md-2">
                <label>Ministry</label>
                <input type="text" class="form-control" name="ministry">
            </div>

            <div class="col-md-2">
                <label>Date From</label>
                <input type="date" class="form-control" name="date_from">
            </div>

            <div class="col-md-2">
                <label>Date To</label>
                <input type="date" class="form-control" name="date_to">
            </div>

            <div class="col-md-1">
                <label>Min â‚¹</label>
                <input type="number" class="form-control" name="min_total">
            </div>

            <div class="col-md-1">
                <label>Max â‚¹</label>
                <input type="number" class="form-control" name="max_total">
            </div>

            <div class="col-md-1">
                <button class="btn btn-primary w-100">Apply</button>
            </div>
        </form>
    </div>

    <!-- CHARTS -->
    <div class="row gy-4">

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header fw-bold">Contracts by Status</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="pie-status"></canvas>
                    </div>
                    <div class="loading-status text-center">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header fw-bold">Total Contract Value Over Time</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="line-value"></canvas>
                    </div>
                    <div class="loading-line text-center">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header fw-bold">Top Ministries</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="bar-ministry"></canvas>
                    </div>
                    <div class="loading-ministry text-center">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header fw-bold">Avg Value by Buying Mode</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="bar-buying-mode"></canvas>
                    </div>
                    <div class="loading-mode text-center">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card h-100">
                <div class="card-header fw-bold">Contracts Count by Month</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="line-month"></canvas>
                    </div>
                    <div class="loading-month text-center">Loadingâ€¦</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // fetch("/user/api/brands/user").then(r=>r.json()).then(console.log)

document.addEventListener("DOMContentLoaded", () => {
    loadUserBrands();
    setupBrandDropdownUX();
});

/* ------------------------------------
   Load brands from backend 
------------------------------------- */
function loadUserBrands() {
    fetch("/user/api/brands/user")
        .then(res => {
            if (!res.ok) throw new Error("Failed to load brands");
            return res.json();
        })
        .then(brands => {
            const menu = document.getElementById("brandDropdownMenu");
            menu.innerHTML = "";

            if (!brands.length) {
                menu.innerHTML =
                    `<li class="dropdown-item text-muted">No brands</li>`;
                return;
            }

            brands.forEach(brand => {
                const safeId = brand.replace(/\s+/g, "_").toLowerCase();

                menu.insertAdjacentHTML("beforeend", `
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input
                                class="form-check-input brand-checkbox"
                                type="checkbox"
                                name="brands[]"
                                value="${brand}"
                                id="brand_${safeId}"
                            >
                            <label class="form-check-label" for="brand_${safeId}">
                                ${brand}
                            </label>
                        </div>
                    </li>
                `);
            });
        })
        .catch(err => {
            console.error("Brand load error:", err);
            document.getElementById("brandDropdownMenu").innerHTML =
                `<li class="dropdown-item text-danger">Error loading brands</li>`;
        });
}

/* ------------------------------------
   UX: update button text
------------------------------------- */
function setupBrandDropdownUX() {
    const dropdownBtn = document.getElementById("brandDropdown");

    document.addEventListener("change", e => {
        if (!e.target.classList.contains("brand-checkbox")) return;

        const checked = document.querySelectorAll(".brand-checkbox:checked");

        if (checked.length === 0) {
            dropdownBtn.textContent = "Select Brands";
        } else if (checked.length === 1) {
            dropdownBtn.textContent = checked[0].value;
        } else {
            dropdownBtn.textContent = `${checked.length} brands selected`;
        }
    });
}
</script>

<script>
function buildQuery(params) {
    const query = new URLSearchParams();

    Object.entries(params).forEach(([key, value]) => {
        if (Array.isArray(value)) {
            value.forEach(v => query.append(key, v));
        } else {
            query.append(key, value);
        }
    });

    return query.toString();
}




//     loadUserBrands();
// function loadUserBrands() {
//     fetch("/user/api/brands/user")
//         .then(r => r.json())
//         .then(brands => {
//             const box = document.getElementById("brand-box");
//             box.innerHTML = "";

//             if (!brands.length) {
//                 box.innerHTML = "<div class='text-muted'>No brands</div>";
//                 return;
//             }

//             brands.forEach(b => {
//                 const id = "brand_" + b.replace(/\s+/g, "_");
//                 box.insertAdjacentHTML("beforeend", `
//                     <div class="form-check">
//                         <input class="form-check-input" type="checkbox" 
//                                name="brands[]" value="${b}" id="${id}">
//                         <label class="form-check-label" for="${id}">
//                             ${b}
//                         </label>
//                     </div>
//                 `);
//             });
//         });
// }
</script>

<script>
function fetchAndDraw(
    endpoint,
    params,
    chart,
    type,
    getLabels,
    getData,
    loadingSelector,
    configOpts = {}
) {
    const loading = document.querySelector(loadingSelector);
    loading.style.display = "block";
    loading.innerText = "Loadingâ€¦";

    // fetch(endpoint + "?" + new URLSearchParams(params))
    fetch(endpoint + "?" + buildQuery(params))
        .then(res => {
            if (!res.ok) throw new Error("API error");
            return res.json();
        })
        .then(data => {
            console.log("API DATA:", endpoint, data);

            const labels = getLabels(data);
            const values = getData(data);

            if (!labels || !labels.length) {
                loading.innerText = "No data";
                return;
            }

            // ðŸ”’ ABSOLUTE SAFE CANVAS LOOKUP
            const cardBody = loading.closest(".card-body");
            const canvas = cardBody.querySelector("canvas");

            if (!canvas) throw new Error("Canvas not found");

            // âœ… DESTROY CHART USING Chart.js REGISTRY
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(canvas, {
                type,
                data: {
                    labels,
                    datasets: [{
                        label: configOpts.label || "",
                        data: values,
                        backgroundColor: configOpts.backgroundColor,
                        borderColor: configOpts.borderColor,
                        fill: configOpts.fill || false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    ...configOpts.options
                }
            });

            loading.style.display = "none";
        })
        .catch(err => {
            console.error("Chart error:", endpoint, err);
            loading.innerText = "Error loading data";
        });
}
</script>


<script>
// function fetchAndDraw(endpoint, params, chart, type, getLabels, getData, loadingSelector, configOpts = {}) {
//     const loading = document.querySelector(loadingSelector);
//     loading.style.display = "block";

//     fetch(endpoint + "?" + new URLSearchParams(params))
//         .then(r => r.json())
//         .then(data => {
//             const labels = getLabels(data);
//             const values = getData(data);

//             if (!labels.length) {
//                 loading.innerText = "No data";
//                 return chart;
//             }

//             if (chart) chart.destroy();

//            const canvas = loading.parentElement.querySelector("canvas");


//             chart = new Chart(canvas, {
//                 type,
//                 data: {
//                     labels,
//                     datasets: [{
//                         label: configOpts.label || "",
//                         data: values,
//                         backgroundColor: configOpts.backgroundColor,
//                         fill: configOpts.fill || false,
//                         tension: 0.3
//                     }]
//                 },
//                 options: {
//                     responsive: true,
//                     maintainAspectRatio: false,
//                     ...configOpts.options
//                 }
//             });

//             loading.style.display = "none";
//         })
//         .catch(() => loading.innerText = "Error loading data");

//     return chart;
// }

const pieBg = [
    "rgba(54,162,235,.6)", "rgba(255,99,132,.6)",
    "rgba(255,206,86,.6)", "rgba(75,192,192,.6)",
    "rgba(153,102,255,.6)", "rgba(255,159,64,.6)"
];

let pieChart, lineValueChart, barMinistryChart, barModeChart, lineMonthChart;

// function getFilters() {
//     const formData = new FormData(document.getElementById("analytics-filters"));
//     return Object.fromEntries([...formData.entries()].filter(([k,v]) => v));
// }

function getFilters() {
    const form = document.getElementById("analytics-filters");
    const formData = new FormData(form);

    const filters = {};

    // Normal fields
    for (let [key, value] of formData.entries()) {
        if (key !== "brands[]" && value) {
            filters[key] = value;
        }
    }

    // âœ… Collect checked brands properly
    const brands = Array.from(
        document.querySelectorAll(".brand-checkbox:checked")
    ).map(cb => cb.value);

    if (brands.length) {
        filters["brands[]"] = brands;
    }

    return filters;
}


function loadAllCharts() {
    const filters = getFilters();

    pieChart = fetchAndDraw("/user/api/analytics/contracts_by_status", filters, pieChart, "doughnut",
        d => d.map(x => x.status), d => d.map(x => x.count), ".loading-status",
        { backgroundColor: pieBg });

    lineValueChart = fetchAndDraw("/user/api/analytics/value_over_time", filters, lineValueChart, "line",
        d => d.map(x => x.date), d => d.map(x => x.total), ".loading-line",
        { label: "Total Value", options: { scales: { y: { beginAtZero: true }}}});

    barMinistryChart = fetchAndDraw("/user/api/analytics/top_ministries", filters, barMinistryChart, "bar",
        d => d.map(x => x.ministry), d => d.map(x => x.value), ".loading-ministry",
        { backgroundColor: pieBg });

    barModeChart = fetchAndDraw("/user/api/analytics/avg_by_buying_mode", filters, barModeChart, "bar",
        d => d.map(x => x.buying_mode), d => d.map(x => x.avg_value), ".loading-mode",
        { backgroundColor: pieBg });

    lineMonthChart = fetchAndDraw("/user/api/analytics/count_by_month", filters, lineMonthChart, "line",
        d => d.map(x => `${x.year}-${String(x.month).padStart(2,"0")}`), d => d.map(x => x.count),
        ".loading-month", { label: "Contracts" });
}

document.getElementById("analytics-filters").addEventListener("submit", e => {
    e.preventDefault();
    loadAllCharts();
});

window.addEventListener("DOMContentLoaded", loadAllCharts);
</script>

{% endblock %}
