{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}

{% block content %}

<!-- =========================
  WELCOME CARD (UNCHANGED)
========================= -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h1 class="h4">Welcome, {{ current_user.username }}!</h1>
    {% if current_user.is_verified %}
      <p class="mb-0">Your account is verified. You can access all user features.</p>
    {% else %}
      <p class="mb-0 text-warning">
        Your account is not yet verified. Some features may be restricted.
      </p>
    {% endif %}
  </div>
</div>

<!-- =========================
  NUMERICAL ANALYTICS DASHBOARD
========================= -->
<div class="container-fluid px-0">

  <h4 class="mb-3">ðŸ“Š Contracts â€“ Numerical Analytics</h4>

  <!-- KPI CARDS -->
  <div class="row mb-4" id="kpiRow"></div>

  <!-- CONTRACT STATUS -->
  <div class="card mb-4">
    <div class="card-header fw-semibold">Contracts by Status</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0" id="statusTable"></table>
    </div>
  </div>

  <!-- BUYING MODE -->
  <div class="card mb-4">
    <div class="card-header fw-semibold">Buying Mode Summary</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0" id="buyingTable"></table>
    </div>
  </div>

  <!-- TOP MINISTRIES -->
  <div class="card mb-4">
    <div class="card-header fw-semibold">Top Ministries</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0" id="ministryTable"></table>
    </div>
  </div>

</div>

<!-- =========================
  JAVASCRIPT (USES EXISTING APIs)
========================= -->
<script>
const queryParams = new URLSearchParams(window.location.search);

// --------------------
// LOAD NUMERICAL DASHBOARD
// --------------------
async function loadNumericDashboard() {

  // ---------- STATUS ----------
  const statusData = await fetch(
    "/api/analytics/contracts_by_status?" + queryParams
  ).then(r => r.json());

  let totalContracts = 0;
  statusData.forEach(r => totalContracts += r.count);

  // ---------- VALUE ----------
  const valueData = await fetch(
    "/api/analytics/value_over_time?" + queryParams
  ).then(r => r.json());

  let totalValue = 0;
  valueData.forEach(r => totalValue += r.total);

  // ---------- BUYING MODE ----------
  const buyingData = await fetch(
    "/api/analytics/avg_by_buying_mode?" + queryParams
  ).then(r => r.json());

  // ---------- KPI CARDS ----------
  document.getElementById("kpiRow").innerHTML = `
    ${kpiCard("Total Contracts", totalContracts)}
    ${kpiCard("Total Contract Value", "â‚¹" + totalValue.toLocaleString())}
    ${kpiCard("Buying Modes", buyingData.length)}
    ${kpiCard(
      "Avg Contract Value",
      "â‚¹" + (totalContracts ? Math.round(totalValue / totalContracts).toLocaleString() : 0)
    )}
  `;

  // ---------- STATUS TABLE ----------
  renderTable(
    "statusTable",
    ["Status", "Contracts"],
    statusData.map(r =>
      `<tr>
        <td>${r.status || "-"}</td>
        <td>${r.count}</td>
      </tr>`
    )
  );

  // ---------- BUYING MODE TABLE ----------
  renderTable(
    "buyingTable",
    ["Buying Mode", "Avg Value â‚¹"],
    buyingData.map(r =>
      `<tr>
        <td>${r.buying_mode}</td>
        <td>${Math.round(r.avg_value).toLocaleString()}</td>
      </tr>`
    )
  );

  // ---------- TOP MINISTRIES ----------
  const ministryData = await fetch(
    "/api/analytics/top_ministries?" + queryParams
  ).then(r => r.json());

  renderTable(
    "ministryTable",
    ["Ministry", "Value â‚¹"],
    ministryData.map(r =>
      `<tr>
        <td>${r.ministry}</td>
        <td>${Math.round(r.value).toLocaleString()}</td>
      </tr>`
    )
  );
}

// --------------------
// UI HELPERS
// --------------------
function kpiCard(title, value) {
  return `
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">${title}</div>
          <div class="fs-4 fw-semibold mt-1">${value}</div>
        </div>
      </div>
    </div>
  `;
}

function renderTable(id, headers, rows) {
  document.getElementById(id).innerHTML = `
    <thead>
      <tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>
    </thead>
    <tbody>${rows.join("")}</tbody>
  `;
}

// INIT
loadNumericDashboard();
</script>

{% endblock %}








<!-- 
<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h4">Welcome, {{ current_user.username }}!</h1>
    {% if current_user.is_verified %}
      <p class="mb-0">Your account is verified. You can access all user features.</p>
    {% else %}
      <p class="mb-0 text-warning">Your account is not yet verified. Some features may be restricted.</p>
    {% endif %}
  </div>
</div>
 -->
