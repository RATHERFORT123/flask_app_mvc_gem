<!-- user_contract_info.html -->



{% extends "base.html" %}
{% block title %}USER CONTRACTS{% endblock %}
{% block content %}
<style>
    .box {
        border-radius: 12px;
        box-shadow: 0 2px 12px #e9ecef;
    }

    .box-header {
        font-weight: 700;
        font-size: 1.1rem;
    }

    .filter-label {
        font-size: .94rem;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .pagination {
        margin-top: 16px;
    }


    .select2-container .select2-selection--single {
        height: 34px !important;
    }

    .select2-container--default .select2-selection--single {
        border: 1px solid #ccc !important;
        border-radius: 0px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 34px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 34px !important;
    }
</style>
<div class="container">
    <h1 class="fw-bold mb-1">Contract Management</h1>
    <div class="mb-3 text-muted">Comprehensive contract oversight and analysis</div>

    <form class="box p-4 mb-4 bg-white" method="get">
        <div class="box-header mb-3"><span class="me-2">ðŸ”Ž</span>Search & Filter Contracts</div>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="filter-label">Search</label>
                <input type="text" class="form-control" name="search" value="{{ filters_applied.get('search', '') }}"
                    placeholder="Contract ID, Buyer, Seller or Product">
            </div>
            <div class="col-md-2">
                <label class="filter-label">From</label>
                <input type="date" class="form-control" name="date_from"
                    value="{{ filters_applied.get('date_from','') }}">
            </div>
            <div class="col-md-2">
                <label class="filter-label">To</label>
                <input type="date" class="form-control" name="date_to" value="{{ filters_applied.get('date_to','') }}">
            </div>
            <div class="col-md-2">
                <label class="filter-label">Status</label>
                <select class="form-select" name="status">
                    <option value="">All Statuses</option>
                    {% for status in [
                    "Fullfillment in Progress",
                    "Order Completed",
                    "Order Accepted",
                    "Order Paid",
                    "Order Cancelled",
                    "Waiting for Seller Confirmation",
                    "Waiting for Seller Payment",
                    "Cancellation Requested by Buyer",
                    "Waiting For Payment Confirmation",
                    "OrderPlaced",
                    "WaitingForBuyerAction"
                    ] %}
                    <option value="{{status}}" {% if filters_applied.get('status','')==status %}selected{% endif %}>
                        {{status.title()}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="filter-label">Buying_mode</label>
                <select class="form-select" name="buying_mode">
                    <option value="">All Types</option>
                    {% for t in ['Bid/RA', 'Direct'] %}
                    <option value="{{t}}" {% if filters_applied.get('type','')==t %}selected{% endif %}>{{t.title()}}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="filter-label">Value Range</label>
                <div class="input-group">
                    <input type="number" class="form-control" name="min_total" placeholder="Min"
                        value="{{ filters_applied.get('min_total','') }}">
                    <input type="number" class="form-control" name="max_total" placeholder="Max"
                        value="{{ filters_applied.get('max_total','') }}">
                </div>
            </div>

            <div class="col-md-2">
                <label>Ministry</label>
                <select class="form-control select2" id="ministry" name="ministry">
                    <option value="">--Select--</option>
                    <option value=""></option>
                    <option value="">All Types</option>
                    {% for t in [
                    "Autonomous Body",
                    "Central Government",
                    "Central PSU",
                    "Comptroller and Auditor General (CAG) of India",
                    "Election Commission of India",
                    "GOA",
                    "Indian Atomic Industiral Forum (IAIF)",
                    "Insurance Regulatory and Development Authority (IRDA)",
                    "LADAKH",
                    "Law Commission of India",
                    "Lok Sabha Secretariat",
                    "MIZORAM",
                    "Ministry of AYUSH",
                    "Ministry of Agriculture and Farmers Welfare",
                    "Ministry of Chemicals and Fertilizers",
                    "Ministry of Civil Aviation",
                    "Ministry of Coal",
                    "Ministry of Commerce and Industry",
                    "Ministry of Communications",
                    "Ministry of Consumer Affairs Food and Public Distribution",
                    "Ministry of Corporate Affairs",
                    "Ministry of Culture",
                    "Ministry of Development of North Eastern Region",
                    "Ministry of Drinking Water and Sanitation",
                    "Ministry of Earth Sciences",
                    "Ministry of Education",
                    "Ministry of Electronics and Information Technology",
                    "Ministry of Environment Forest and Climate Change",
                    "Ministry of External Affairs",
                    "Ministry of Finance",
                    "Ministry of Food Processing Industries",
                    "Ministry of Health and Family Welfare",
                    "Ministry of Heavy Industries and Public Enterprises",
                    "Ministry of Housing & Urban Affairs (MoHUA)",
                    "Ministry of Housing and Urban Poverty Alleviation",
                    "Ministry of Human Resource Development",
                    "Ministry of Information and Broadcasting",
                    "Ministry of Labour and Employment",
                    "Ministry of Law and Justice",
                    "Ministry of Micro Small and Medium Enterprises",
                    "Ministry of Mines",
                    "Ministry of Minority Affairs",
                    "Ministry of New and Renewable Energy",
                    "Ministry of Panchayati Raj",
                    "Ministry of Parliamentary Affairs",
                    "Ministry of Personnel Public Grievances and Pensions",
                    "Ministry of Petroleum and Natural Gas",
                    "Ministry of Ports, Shipping and Waterways",
                    "Ministry of Power",
                    "Ministry of Railways",
                    "Ministry of Road Transports and highways",
                    "Ministry of Rural Development ",
                    "Ministry of Science and Technology",
                    "Ministry of Skill Development and Entrepreneurship",
                    "Ministry of Social Justice and Empowerment",
                    "Ministry of Statistics and Programme Implementation",
                    "Ministry of Steel",
                    "Ministry of Textiles",
                    "Ministry of Tourism",
                    "Ministry of Tribal Affairs",
                    "Ministry of Urban Development",
                    "Ministry of Water Resources River Development and Ganga Rejuvenation",
                    "Ministry of Women and Child Development",
                    "Ministry of Youth Affairs and Sports",
                    "NITI Aayog - National Institution for Transforming India",
                    "National Commission for Scheduled Tribes (NCST)",
                    "National Mission for Clean Ganga (NMCG), New Delhi",
                    "National Rural Livelihoods Mission (NRLM) - Aajeevika",
                    "Office of the Principal Scientific Adviser",
                    "Organistion Incomplete",
                    "President of India",
                    "Primary User",
                    "Rajya Sabha Secretariat",
                    "SIKKIM",
                    "Seventh Central Pay Commission, New Delhi",
                    "Staff Selection Commision",
                    "Union Public Service Commission (UPSC)",
                    "Vice President of India"
                    ] %}
                    <option value="{{t}}" {% if filters_applied.get('ministry','')==t %}selected{% endif %}>
                        {{t.title()}}
                    </option>
                    {% endfor %}


                </select>
            </div>

            <div class="col-md-2">
                <label class="filter-label invisible">...</label>
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
            <div class="col-md-2 text-end">
                <label class="filter-label invisible">...</label>
                <a href="{{ url_for('user.user_contracts') }}" class="btn btn-light w-100">Clear All</a>
            </div>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <span class="fs-5 fw-bold">ðŸ“„ Contracts Overview ({{pagination.total}})</span>
        </div>
        <div>
            <a href="?export=excel" class="btn btn-success btn-sm">Export Excel</a>
            <a href="?export=pdf" class="btn btn-danger btn-sm ms-2">Export PDF</a>
        </div>
    </div>

    <div class="box bg-white p-3">
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>ID</th>
                        <th>Contract ID</th>
                        <th>Status</th>
                        <th>Organization Type</th>
                        <!-- <th>Ministry</th> -->
                        <!-- <th>Department</th>
                        <th>Organization Name</th>
                        <th>Office Zone</th>
                        <th>Location</th>
                        <th>Buyer Designation</th>
                        <th>Buying Mode</th>
                        <th>Bid Number</th>
                        <th>Contract Date</th>
                        <th>Total</th>
                        <th>Items (summary)</th> -->
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in contracts %}
                    <tr>
                        <td>{{ contract.id }}</td>
                        <td>{{ contract.contract_id }}</td>
                        <td>{{ contract.status }}</td>
                        <td>{{ contract.organization_type }}</td>
                        <!-- <td>{{ contract.ministry }}</td>
                        <td>{{ contract.department }}</td>
                        <td>{{ contract.organization_name }}</td>
                        <td>{{ contract.office_zone }}</td>
                        <td>{{ contract.location }}</td>
                        <td>{{ contract.buyer_designation }}</td>
                        <td>{{ contract.buying_mode }}</td>
                        <td>{{ contract.bid_number }}</td>
                        <td>{{ contract.contract_date }}</td>
                        <td>{{ contract.total }}</td> -->
                        <!-- <td>
                            {% set item_summaries = [] %}
                            {% for item in contract.items %}
                            {% set summary = [] %}
                            {% if item.service %}{% set _ = summary.append("S:" ~ item.service) %}{% endif %}
                            {% if item.product %}{% set _ = summary.append("P:" ~ item.product) %}{% endif %}
                            {% if item.brand %}{% set _ = summary.append("B:" ~ item.brand) %}{% endif %}
                            {% if item.model %}{% set _ = summary.append("M:" ~ item.model) %}{% endif %}
                            {% set _ = item_summaries.append(summary | join(", ")) %}
                            {% endfor %}
                            {{ item_summaries | join(" | ") }}
                        </td> -->

                        <td>
<button
    class="btn btn-outline-secondary btn-sm view-contract-btn"
    data-contract-id="{{ contract.contract_id }}"
    data-status="{{ contract.status }}"
    data-org="{{ contract.organization_name }}"
    data-date="{{ contract.contract_date }}"
    data-total="{{ contract.total }}"
    data-items="{% for item in contract.items %}
        {% if item.service %}S:{{ item.service }} {% endif %}
        {% if item.product %}P:{{ item.product }} {% endif %}
        {% if item.brand %}B:{{ item.brand }} {% endif %}
        {% if item.model %}M:{{ item.model }} {% endif %}
        |{% endfor %}"
>
    View
</button>


                            <!-- <button class="btn btn-outline-secondary btn-sm view-contract-btn"
                                data-contract-id="{{ contract.contract_id }}">
                                View
                            </button> -->


                        </td>


                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="16" class="text-center">No contracts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
        <div class="d-flex justify-content-end mt-2">
            <nav>
                <ul class="pagination mb-0">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{pagination.prev_num}}{% for k, v in filters_applied.items() %}&{{k}}={{v}}{% endfor %}">&laquo;
                            Prev</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link">Page {{pagination.page}} of {{pagination.pages}}</span>
                    </li>
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{pagination.next_num}}{% for k, v in filters_applied.items() %}&{{k}}={{v}}{% endfor %}">Next
                            &raquo;</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Contract Detail Modal -->
<div class="modal fade" id="contractDetailModal" tabindex="-1" aria-labelledby="contractDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractDetailLabel">Contract Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contractModalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
// Helper function to display field or 'None'
function displayOrNone(value) {
    return value ?? "None"
}

// document.addEventListener('DOMContentLoaded', function () {
//     const modal = new bootstrap.Modal(document.getElementById('contractDetailModal'))
//     const modalBody = document.getElementById('contractModalBody')

//     document.querySelectorAll('.view-contract-btn').forEach(button => {
//         button.addEventListener('click', function () {
//             const contractId = this.getAttribute('data-contract-id')
//             modalBody.innerHTML = 'Loading...'
//             modal.show()

//             fetch(`/user/contract/api/${contractId}`)
//                 .then(response => response.json())
//                 .then(data => {
//                     if (!data.contract) {
//                         modalBody.innerHTML = `<p class="text-danger">${data.error || 'Contract not found.'}</p>`
//                         return
//                     }
//                     const contract = data.contract
//                     const seller = data.seller // may be null

//                     let itemsHtml = '<ul>'
//                     contract.items.forEach(item => {
//                         itemsHtml += '<li>'
//                         itemsHtml += `Service: ${displayOrNone(item.service)} | `
//                         itemsHtml += `Product: ${displayOrNone(item.product)} | `
//                         itemsHtml += `Brand: ${displayOrNone(item.brand)} | `
//                         itemsHtml += `Model: ${displayOrNone(item.model)}`
//                         itemsHtml += '</li>'
//                     })
//                     itemsHtml += '</ul>'

//                     let sellerHtml = ''
//                     if (seller) {
//                         sellerHtml = `<h5>Seller Information</h5>
//                         <dl>
//                             <dt>Company Name:</dt><dd>${displayOrNone(seller.company_name)}</dd>
//                             <dt>Seller ID:</dt><dd>${displayOrNone(seller.seller_id)}</dd>
//                             <dt>Contact No:</dt><dd>${displayOrNone(seller.contact_no)}</dd>
//                             <dt>Email:</dt><dd>${displayOrNone(seller.email)}</dd>
//                             <dt>Address:</dt><dd>${displayOrNone(seller.address)}</dd>
//                             <dt>MSME Reg No:</dt><dd>${displayOrNone(seller.msme_reg_no)}</dd>
//                             <dt>GSTIN:</dt><dd>${displayOrNone(seller.gstin)}</dd>
//                         </dl>`
//                     } else {
//                         sellerHtml = '<p>No seller information available.</p>'
//                     }

//                     modalBody.innerHTML = `
//                         <h5>Contract Details</h5>
//                         <p><strong>ID:</strong> ${displayOrNone(contract.contract_id)}</p>
//                         <p><strong>Status:</strong> ${displayOrNone(contract.status)}</p>
//                         <p><strong>Organization:</strong> ${displayOrNone(contract.organization_name)}</p>
//                         <p><strong>Contract Date:</strong> ${displayOrNone(contract.contract_date)}</p>
//                         <p><strong>Total:</strong> ${displayOrNone(contract.total)}</p>
                        
//                         <h5>Items</h5>
//                         ${itemsHtml}

//                         ${sellerHtml}
//                     `
//                 })
//                 .catch(err => {
//                     modalBody.innerHTML = `<p class="text-danger">Error loading contract details.</p>`
//                 })
//         })
//     })
// })

// </script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = new bootstrap.Modal(
        document.getElementById('contractDetailModal')
    )
    const modalBody = document.getElementById('contractModalBody')

    document.querySelectorAll('.view-contract-btn').forEach(button => {
        button.addEventListener('click', function () {

            modalBody.innerHTML = `
                <h5>Contract Details</h5>
                <p><strong>Contract ID:</strong> ${this.dataset.contractId}</p>
                <p><strong>Status:</strong> ${this.dataset.status}</p>
                <p><strong>Organization:</strong> ${this.dataset.org}</p>
                <p><strong>Contract Date:</strong> ${this.dataset.date}</p>
                <p><strong>Total:</strong> ${this.dataset.total}</p>

                <h5>Items</h5>
                <p>${this.dataset.items}</p>
            `

            modal.show()
        })
    })
})
</script>


{% endblock %}